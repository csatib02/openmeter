// Copyright Â© 2024 Tailfin Cloud Inc.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package httpdriver

import (
	"context"
	"errors"
	"net/http"

	"github.com/openmeterio/openmeter/openmeter/namespace/namespacedriver"
	"github.com/openmeterio/openmeter/openmeter/notification"
	"github.com/openmeterio/openmeter/pkg/framework/commonhttp"
	"github.com/openmeterio/openmeter/pkg/framework/transport/httptransport"
)

type Handler interface {
	ChannelHandler
	RuleHandler
	EventHandler
}

type ChannelHandler interface {
	ListChannels() ListChannelsHandler
	CreateChannel() CreateChannelHandler
	DeleteChannel() DeleteChannelHandler
	GetChannel() GetChannelHandler
	UpdateChannel() UpdateChannelHandler
}

type RuleHandler interface {
	ListRules() ListRulesHandler
	CreateRule() CreateRuleHandler
	DeleteRule() DeleteRuleHandler
	GetRule() GetRuleHandler
	UpdateRule() UpdateRuleHandler
	TestRule() TestRuleHandler
}

type EventHandler interface {
	ListEvents() ListEventsHandler
	GetEvent() GetEventHandler
}

var _ Handler = (*handler)(nil)

type handler struct {
	service          notification.Service
	namespaceDecoder namespacedriver.NamespaceDecoder
	options          []httptransport.HandlerOption
}

func (h *handler) resolveNamespace(ctx context.Context) (string, error) {
	ns, ok := h.namespaceDecoder.GetNamespace(ctx)
	if !ok {
		return "", commonhttp.NewHTTPError(http.StatusInternalServerError, errors.New("internal server error"))
	}

	return ns, nil
}

func New(
	namespaceDecoder namespacedriver.NamespaceDecoder,
	service notification.Service,
	options ...httptransport.HandlerOption,
) Handler {
	return &handler{
		service:          service,
		namespaceDecoder: namespaceDecoder,
		options:          options,
	}
}
